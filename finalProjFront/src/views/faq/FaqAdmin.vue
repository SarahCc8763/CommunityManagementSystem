<template>
    <div class="container py-4">
        <h1 class="h4 fw-bold mb-4">Â∏∏Ë¶ãÂïèÈ°å (FAQ)</h1>

        <!-- ÂàÜÈ°ûÁØ©ÈÅ∏ + Êü•Ë©¢ -->
        <div class="row my-3 align-items-center">
            <!-- ‰∏äÊñπÊñ∞Â¢ûËàáÂàÜÈ°ûÁ∂≠Ë≠∑ÊåâÈàï -->
            <div class="text-end my-2">
                <button class="btn  me-2" @click="openAddModal">Êñ∞Â¢û FAQ</button>
                <button class="btn " @click="openCategoryModal">ÂàÜÈ°ûÁ∂≠Ë≠∑</button>
            </div>
            <!-- Â∑¶ÂÅ¥ÂàÜÈ°ûÊåâÈàï -->
            <div class="col-md-8 d-flex flex-wrap gap-2">
                <button @click="selectCategory('ÂÖ®ÈÉ®')" :class="buttonClass('ÂÖ®ÈÉ®')">ÂÖ®ÈÉ®</button>
                <button v-for="cat in categories" :key="cat" @click="selectCategory(cat)" :class="buttonClass(cat)">
                    {{ cat }}
                </button>
            </div>

            <!-- Âè≥ÂÅ¥ÊêúÂ∞ãÊ¨Ñ‰Ωç -->
            <div class="col-md-4 mt-2 mt-md-0">
                <div class="input-group mt-2">
                    <input type="text" class="form-control" placeholder="Ëº∏ÂÖ•ÈóúÈçµÂ≠óÊü•Ë©¢" v-model="searchKeyword"
                        @keyup.enter="searchFaqs" />
                    <button class="btn btn-primary" type="button" @click="searchFaqs">Êü•Ë©¢</button>
                    <button class="btn btn-primary" @click="clearSearch">Ê∏ÖÈô§ÊêúÂ∞ã</button>
                </div>
            </div>
        </div>

        <!-- FAQ Accordion -->
        <div v-if="loading">ËºâÂÖ•‰∏≠...</div>
        <div v-else>
            <div v-if="filteredFaqs.length === 0" class="text-muted">ÁÑ°Á¨¶ÂêàË≥áÊñô</div>

            <div class="accordion " id="faqAccordion">
                <div class="accordion-item " v-for="faq in paginatedFaqs" :key="faq.id">
                    <h2 class="accordion-header" :id="`heading-${faq.id}`">
                        <button class="accordion-button fw-normal" :class="{ 'collapsed': faq.isExpanded }"
                            @click="toggle(faq)" type="button">
                            <!-- ÂÖßÂÆπ -->

                            <span class="badge rounded-pill me-2 fs-6 py-2 "
                                :class="getCategoryBadgeClass(faq.category)">
                                {{ faq.category }}
                            </span>
                            <span style="font-size: 120%;">{{ faq.question }} <small v-if="!faq.postStatus"
                                    class="text-secondary">( Êú™ÂÖ¨Èñã
                                    )</small></span>
                        </button>
                    </h2>
                    <div v-show="faq.isExpanded" :id="`collapse-${faq.id}`" class="accordion-collapse"
                        :aria-labelledby="`heading-${faq.id}`" style="font-size: 110%;">
                        <div class="accordion-body d-flex flex-column justify-content-between"
                            style="min-height: 180px;">
                            <!-- ‰∏ªË¶ÅÂÖßÂÆπÂçÄ -->
                            <div>
                                <p class="mb-2">{{ faq.answer }}</p>
                            </div>

                            <!-- Â∫ïÈÉ®ÂàóÔºöÂàÜÈ°ûËàáÊåâÈàïÂú®Âêå‰∏ÄË°å -->
                            <div class="mt-auto d-flex justify-content-between align-items-end flex-wrap gap-2">
                                <!-- ÂàÜÈ°ûËàáÈóúÈçµÂ≠ó -->
                                <div class="small" style="color: #BEBEBE;">
                                    ÂàÜÈ°ûÔºö{{ faq.category }}„ÄÄ
                                    ÈóúÈçµÂ≠óÔºö{{ faq.keywords?.join(', ') || '‚Äî' }}
                                </div>

                                <!-- Á∑®ËºØËàáÂà™Èô§ÊåâÈàï -->
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-primary"
                                        @click="openEditModal(faq)">Á∑®ËºØ</button>
                                    <button class="btn btn-sm btn-outline-danger"
                                        @click="confirmDelete(faq.id)">Âà™Èô§</button>
                                </div>
                            </div>
                        </div>


                    </div>
                </div>
            </div>

            <!-- ÂàÜÈ†ÅÊéßÂà∂ -->
            <nav class="mt-4" v-if="totalPages > 1">
                <ul class="pagination justify-content-center">
                    <li class="page-item" :class="{ disabled: page === 1 }">
                        <a class="page-link" href="#" @click.prevent="prevPage">‰∏ä‰∏ÄÈ†Å</a>
                    </li>
                    <li class="page-item disabled">
                        <span class="page-link">Á¨¨ {{ page }} È†Å / ÂÖ± {{ totalPages }} È†Å</span>
                    </li>
                    <li class="page-item" :class="{ disabled: page === totalPages }">
                        <a class="page-link" href="#" @click.prevent="nextPage">‰∏ã‰∏ÄÈ†Å</a>
                    </li>
                </ul>
            </nav>
        </div>

        <!-- FAQ Ë°®ÂñÆ Modal -->
        <FaqFormModal :visible="showFaqModal" @update:visible="showFaqModal = $event" :faqData="editingFaq"
            :communityId="1" :categoryOptions="categories" @submitted="fetchFaqs" />
        <FaqCategoryModal :visible="showCategoryModal" @update:visible="showCategoryModal = $event" :communityId="1"
            @updated="fetchFaqs" />

    </div>
</template>

<script setup>
import { ref, onMounted, computed, nextTick, watch } from 'vue'

import FaqFormModal from '@/components/faq/FaqFormModal.vue'
import FaqCategoryModal from '@/components/faq/FaqCategoryModal.vue'
import Swal from 'sweetalert2'
import { useUserStore } from '@/stores/UserStore'
import bootstrap from 'bootstrap/dist/js/bootstrap.bundle.min.js'



const userStore = useUserStore()
const userId = userStore.userId || 0 // ÂÅáË®≠Áï∂Ââç‰ΩøÁî®ËÄÖ id
const communityId = userStore.communityId || 0 // ÂÅáË®≠Áï∂ÂâçÁ§æÂçÄ ID
import axios from '@/plugins/axios'


const fullfaqList = ref([])
const faqList = ref([])
const categories = ref([])
const loading = ref(true)

const selectedCategory = ref('ÂÖ®ÈÉ®')
const page = ref(1)
const pageSize = 10
const searchKeyword = ref('')

const showFaqModal = ref(false)
const editingFaq = ref(null)
const showCategoryModal = ref(false)


const openEditModal = (faq) => {
    editingFaq.value = { ...faq }
    showFaqModal.value = true
}

const openAddModal = () => {
    editingFaq.value = null
    showFaqModal.value = true
}

const openCategoryModal = () => {
    showCategoryModal.value = true
}

const confirmDelete = async (faqId) => {
    const result = await Swal.fire({
        title: 'Á¢∫ÂÆöË¶ÅÂà™Èô§ÂóéÔºü',
        text: 'Âà™Èô§ÂæåÂ∞áÁÑ°Ê≥ïÊÅ¢Âæ©',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Á¢∫ÂÆö',
        cancelButtonText: 'ÂèñÊ∂à'
    })

    if (result.isConfirmed) {
        try {
            await axios.delete(`/api/faq/${faqId}`)
            await fetchFaqs()
            Swal.fire('Âà™Èô§ÊàêÂäü', '', 'success')
        } catch (err) {
            //console.error(err)
            Swal.fire('Âà™Èô§Â§±Êïó', '', 'error')
        }
    }
}


// Ë®àÁÆóÈ°ØÁ§∫Áî® FAQ
const filteredFaqs = computed(() =>
    selectedCategory.value === 'ÂÖ®ÈÉ®'
        ? faqList.value
        : faqList.value.filter(faq => faq.category === selectedCategory.value)
)

const totalPages = computed(() =>
    Math.ceil(filteredFaqs.value.length / pageSize)
)

const paginatedFaqs = computed(() => {
    const start = (page.value - 1) * pageSize
    return filteredFaqs.value.slice(start, start + pageSize)
})

const toggle = (targetFaq) => {
    faqList.value.forEach(faq => {
        if (faq === targetFaq) {
            faq.isExpanded = !faq.isExpanded // ÂàáÊèõËá™Â∑±
        } else {
            faq.isExpanded = false // ÂÖ∂‰ªñÈóúÊéâ
        }
    })
}


// üîπÂèñÂæó FAQ Ë≥áÊñôÔºàÂàùÂßãÁî®Ôºâ
const fetchFaqs = async () => {
    loading.value = true
    try {
        const [faqRes, categoryRes] = await Promise.all([
            axios.get(`/api/faq/community/${communityId}`),
            axios.get(`/api/faq/${communityId}/category`)
        ])

        const categoryOrder = categoryRes.data || []
        categories.value = categoryOrder

        if (faqRes.data.success) {
            fullfaqList.value = faqRes.data.list.sort((a, b) => {
                const aIndex = categoryOrder.indexOf(a.category)
                const bIndex = categoryOrder.indexOf(b.category)
                return aIndex - bIndex
            })
            faqList.value = fullfaqList.value.map(faq => ({ ...faq, isExpanded: false }))
        }

    } catch (error) {
        //console.error('ÂèñÂæóFAQÊàñÂàÜÈ°ûÂ§±Êïó:', error)
    } finally {
        loading.value = false
    }
}


watch(paginatedFaqs, async (faqs) => {
    await nextTick()
    faqs.forEach(faq => {
        const el = document.getElementById(`collapse-${faq.id}`)
        if (el) new bootstrap.Collapse(el, { toggle: false })
    })
})




// üîπÊü•Ë©¢ FAQÔºàÂàÜÈ°û/ÈóúÈçµÂ≠óÔºâ
const searchFaqs = async () => {
    loading.value = true

    const requestBody = {}
    if (selectedCategory.value !== 'ÂÖ®ÈÉ®') {
        requestBody.category = { name: selectedCategory.value }
    }
    if (searchKeyword.value.trim() !== '') {
        requestBody.keywords = searchKeyword.value.trim()
    }


    try {
        const res = await axios.post('/api/faq/searchbykeyword', requestBody)
        if (res.data.success) {
            // ‚úÖ ÈáçÊñ∞‰æùÂàÜÈ°ûÈ†ÜÂ∫èÊéíÂ∫è
            const categoryOrder = categories.value
            faqList.value = res.data.list.sort((a, b) => {
                const aIndex = categoryOrder.indexOf(a.category)
                const bIndex = categoryOrder.indexOf(b.category)
                return aIndex - bIndex
            })
            page.value = 1
        }
    } catch (error) {
        //console.error('Êü•Ë©¢ FAQ Â§±Êïó:', error)
    } finally {
        loading.value = false
    }
}
const clearSearch = () => {
    searchKeyword.value = ''
    selectedCategory.value = 'ÂÖ®ÈÉ®'
    faqList.value = [...fullfaqList.value]
    page.value = 1
}

const selectCategory = (cat) => {
    selectedCategory.value = cat
    page.value = 1

    if (cat === 'ÂÖ®ÈÉ®' && searchKeyword.value.trim() === '') {
        // ‚úÖ Â¶ÇÊûúÊ≤íËº∏ÂÖ•ÈóúÈçµÂ≠ó‰∏îÈÅ∏ÁöÑÊòØÂÖ®ÈÉ® ‚Üí ÈÇÑÂéüÂàùÂßã faqList
        faqList.value = [...fullfaqList.value]
    } else {
        // ‚úÖ ÂÖ∂‰ªñÊÉÖÊ≥ÅÂ∞±ÈáçÊñ∞Êü•Ë©¢
        searchFaqs()
    }
}


const formatDate = (dateStr) => new Date(dateStr).toLocaleString()

const prevPage = () => {
    if (page.value > 1) page.value--
}

const nextPage = () => {
    if (page.value < totalPages.value) page.value++
}

const buttonClass = (cat) =>
    `btn-class ${selectedCategory.value === cat ? 'btn-outline-class' : ''}`

const getCategoryBadgeClass = (category) => {
    const index = categories.value.indexOf(category)
    const colorIndex = index % 3
    switch (colorIndex) {
        case 0: return 'bg-danger'
        case 1: return 'bg-success'
        case 2: return 'bg-warning'
        default: return 'bg-secondary'
    }
}



onMounted(() => {
    fetchFaqs()

})
</script>

<style scoped>
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 8px 16px;
    border: none;
    border-radius: 12px;
    font-size: 18px;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    /* transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); */
    position: relative;
    overflow: hidden;
    background: linear-gradient(135deg, #5864a1 0%, #5f3d81 100%);
    color: white;
    box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
}

.btn-class {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 5px 10px !important;
    border: none;
    border-radius: 20px;
    font-size: 18px;
    font-weight: 400;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    background: rgb(61, 88, 114);

    color: white;
    box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
}

.btn-outline-class {

    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
    /* ÂèØÊúâÂèØÁÑ°ÔºöËóçËâ≤ÂÖâÊöàÊÑü */
    background: rgb(108, 136, 162);
    background: linear-gradient(135deg, #9eace9 0%, #764ba2 100%);
    font-weight: 600;


}





.btn:hover {
    transform: translateY(0px);
    /* box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4); */
}

/* ‰øÆÊîπÊï¥ÂÄã Accordion ÊØèÂÄã item ÁöÑËÉåÊôØ */
.accordion-item {
    background-color: #3A2A5D !important;
    border: 3px solid #384464;

}

/* ‰øÆÊîπÂ±ïÈñãËàáÊú™Â±ïÈñãÁöÑÊ®ôÈ°åÊåâÈàïËÉåÊôØ */
.accordion-button {
    background-color: #202d44;
    /* Ëá™Ë®ÇÊ®ôÈ°åËÉåÊôØ */
    color: #ffffff;
    font-weight: 600;

}

/* Áï∂ÊäòÁñäÊôÇÁöÑÊ®£ÂºèÔºàÂä†‰∏ä collapsedÔºâ */
.accordion-button.collapsed {
    background-color: #182234;
    /* Êú™Â±ïÈñãÁöÑÊåâÈàïÈ°èËâ≤ */
}

/* accordion ÂÖßÂÆπÂçÄÂ°äËÉåÊôØ */
.accordion-body {
    background-color: #34445f;
    color: #f5f5f5;
    font-weight: 400;
    font-size: 100%;
    /* ÂÖßÊñáÁôΩËâ≤ */
}
</style>
